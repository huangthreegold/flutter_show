# ğŸŒ gRPC æ€§èƒ½é—®é¢˜åˆ†æä¸ä¼˜åŒ–æ–¹æ¡ˆ

## ğŸ“Š é—®é¢˜è¯Šæ–­

### å‘ç°çš„æ€§èƒ½ç“¶é¢ˆï¼š

#### 1. **é¢‘ç¹çš„é‡å¤è¯·æ±‚** âš ï¸
```dart
// lib/site_health_real_grpc_service.dart:157-166
Stream<Map<String, int>> getRealtimeMetrics() async* {
  while (_isConnected) {
    final stats = await getHealthStatistics();  // æ¯2ç§’ä¸€æ¬¡
    yield _convertHealthStatisticsToMetrics(stats);
    await Future.delayed(const Duration(seconds: 2));  // â† é—®é¢˜
  }
}
```

**é—®é¢˜ï¼š** æ¯ä¸ª Stream éƒ½ç‹¬ç«‹è½®è¯¢æœåŠ¡å™¨ï¼Œå¯¼è‡´ï¼š
- `getRealtimeMetrics()` - æ¯ **2ç§’** è¯·æ±‚ä¸€æ¬¡
- `getRealtimeVehicleStatus()` - æ¯ **3ç§’** è¯·æ±‚ä¸€æ¬¡
- å¤šä¸ªé¡µé¢åŒæ—¶æ‰“å¼€ = **é‡å¤è¯·æ±‚**

#### 2. **åµŒå¥—æŸ¥è¯¢** ğŸ”¥
```dart
// lib/site_health_real_grpc_service.dart:178
final stats = await getHealthStatistics();      // ç¬¬1ä¸ªè¯·æ±‚
final healthInfo = await queryHealthInfo();     // ç¬¬2ä¸ªè¯·æ±‚ï¼ˆæ›´æ…¢ï¼‰
```

**é—®é¢˜ï¼š** `queryHealthInfo()` éœ€è¦æŸ¥è¯¢å¤§é‡è¯¦ç»†æ•°æ®ï¼Œéå¸¸è€—æ—¶

#### 3. **FutureBuilder é‡å»º** ğŸ“¦
```dart
// lib/main.dart:575
FutureBuilder<pb.HealthInfoQueryResponse>(
  future: widget.grpcService.queryHealthInfo(),  // æ¯æ¬¡rebuildéƒ½ä¼šé‡æ–°è¯·æ±‚
  builder: (context, snapshot) { ... }
)
```

**é—®é¢˜ï¼š** æ¯æ¬¡é¡µé¢é‡å»ºéƒ½ä¼šè§¦å‘æ–°çš„è¯·æ±‚

---

## âš¡ ä¼˜åŒ–æ–¹æ¡ˆ

### æ–¹æ¡ˆ1ï¼šæ•°æ®ç¼“å­˜ï¼ˆæ¨èï¼Œæœ€ç®€å•ï¼‰

ä¿®æ”¹ `lib/site_health_real_grpc_service.dart`ï¼š

```dart
class SiteHealthRealGrpcService {
  // æ·»åŠ ç¼“å­˜
  pb.HealthStatistics? _cachedStats;
  DateTime? _statsCacheTime;
  final Duration _cacheDuration = const Duration(seconds: 5);
  
  /// è·å–å¥åº·ç»Ÿè®¡ï¼ˆå¸¦ç¼“å­˜ï¼‰
  Future<pb.HealthStatistics> getHealthStatistics() async {
    // æ£€æŸ¥ç¼“å­˜
    if (_cachedStats != null && 
        _statsCacheTime != null &&
        DateTime.now().difference(_statsCacheTime!) < _cacheDuration) {
      print('âœ“ ä½¿ç”¨ç¼“å­˜æ•°æ®ï¼ˆ${_cacheDuration.inSeconds}ç§’å†…ï¼‰');
      return _cachedStats!;
    }

    // ç¼“å­˜è¿‡æœŸï¼Œé‡æ–°è·å–
    try {
      final response = await _stub.getHealthStatistics(Empty());
      _cachedStats = response;
      _statsCacheTime = DateTime.now();
      print('âœ“ è·å–æ–°æ•°æ®å¹¶ç¼“å­˜');
      return response;
    } catch (e) {
      print('âœ— è·å–å¤±è´¥: $e');
      rethrow;
    }
  }
}
```

**æ•ˆæœï¼š** 5ç§’å†…çš„é‡å¤è¯·æ±‚ç›´æ¥è¿”å›ç¼“å­˜ï¼Œæ€§èƒ½æå‡ **10-50å€**

---

### æ–¹æ¡ˆ2ï¼šå•ä¸€æ•°æ®æµï¼ˆæ¨èï¼Œæœ€ä½³ï¼‰

```dart
class SiteHealthRealGrpcService {
  // ä½¿ç”¨å•ä¸€æ•°æ®æµ
  late final Stream<pb.HealthStatistics> _statsStream;
  StreamController<pb.HealthStatistics>? _statsController;
  
  void connect(String host, int port) async {
    // ... è¿æ¥ä»£ç  ...
    
    // å¯åŠ¨å•ä¸€è½®è¯¢
    _statsController = StreamController<pb.HealthStatistics>.broadcast();
    _startPolling();
  }
  
  void _startPolling() async {
    while (_isConnected) {
      try {
        final stats = await _stub.getHealthStatistics(Empty());
        _statsController?.add(stats);
        await Future.delayed(const Duration(seconds: 3));  // ç»Ÿä¸€è½®è¯¢é—´éš”
      } catch (e) {
        print('è½®è¯¢å¤±è´¥: $e');
        await Future.delayed(const Duration(seconds: 5));
      }
    }
  }
  
  // æ‰€æœ‰å…¶ä»–æ–¹æ³•åŸºäºè¿™ä¸ªæµ
  Stream<Map<String, int>> getRealtimeMetrics() {
    return _statsController!.stream
        .map((stats) => _convertHealthStatisticsToMetrics(stats));
  }
}
```

**æ•ˆæœï¼š** 
- åªæœ‰ **1ä¸ª** åå°è½®è¯¢
- æ‰€æœ‰é¡µé¢å…±äº«æ•°æ®
- æ€§èƒ½æå‡ **5-10å€**

---

### æ–¹æ¡ˆ3ï¼šè°ƒæ•´è½®è¯¢é—´éš”

```dart
// ä¿®æ”¹è¿™äº›å€¼
await Future.delayed(const Duration(seconds: 2));  // æ”¹ä¸º 5ç§’
await Future.delayed(const Duration(seconds: 3));  // æ”¹ä¸º 5ç§’
```

**æ•ˆæœï¼š** å‡å°‘æœåŠ¡å™¨å‹åŠ›ï¼Œæå‡ **2-3å€**

---

### æ–¹æ¡ˆ4ï¼šç§»é™¤ queryHealthInfo åµŒå¥—è°ƒç”¨

```dart
// âŒ æ—§ä»£ç ï¼ˆæ…¢ï¼‰
Stream<List<VehicleStatusData>> getRealtimeVehicleStatus() async* {
  final stats = await getHealthStatistics();
  final healthInfo = await queryHealthInfo();  // â† ç§»é™¤è¿™ä¸ª
  yield _convertHealthStatisticsToVehicles(stats, healthInfo);
}

// âœ… æ–°ä»£ç ï¼ˆå¿«ï¼‰
Stream<List<VehicleStatusData>> getRealtimeVehicleStatus() async* {
  final stats = await getHealthStatistics();
  yield _convertHealthStatisticsToVehicles(stats);  // åªç”¨stats
}
```

**æ•ˆæœï¼š** å‡å°‘50%çš„è¯·æ±‚ï¼Œé€Ÿåº¦æå‡ **2å€**

---

### æ–¹æ¡ˆ5ï¼šFutureBuilder æ”¹ç”¨ StreamBuilder

```dart
// âŒ æ—§ä»£ç ï¼ˆæ¯æ¬¡rebuildéƒ½è¯·æ±‚ï¼‰
FutureBuilder<pb.HealthInfoQueryResponse>(
  future: widget.grpcService.queryHealthInfo(),
  builder: (context, snapshot) { ... }
)

// âœ… æ–°ä»£ç ï¼ˆå…±äº«æ•°æ®æµï¼‰
StreamBuilder<pb.HealthStatistics>(
  stream: widget.grpcService.getStatsStream(),  // ä½¿ç”¨å…±äº«æµ
  builder: (context, snapshot) { ... }
)
```

---

## ğŸš€ ç«‹å³å¯ç”¨çš„å¿«é€Ÿä¿®å¤

### ä¿®æ”¹1ï¼šå¢åŠ ç¼“å­˜æ—¶é—´
åœ¨ `lib/site_health_real_grpc_service.dart` ç¬¬157è¡Œï¼š

```dart
await Future.delayed(const Duration(seconds: 5));  // ä»2ç§’æ”¹ä¸º5ç§’
```

### ä¿®æ”¹2ï¼šç§»é™¤è¯¦ç»†æŸ¥è¯¢
åœ¨ `lib/site_health_real_grpc_service.dart` ç¬¬178è¡Œï¼š

```dart
// æ³¨é‡Šæ‰è¿™è¡Œ
// final healthInfo = await queryHealthInfo();
```

### ä¿®æ”¹3ï¼šæ·»åŠ ç®€å•ç¼“å­˜
åœ¨ç±»é¡¶éƒ¨æ·»åŠ ï¼š

```dart
pb.HealthStatistics? _lastStats;
DateTime? _lastFetchTime;

Future<pb.HealthStatistics> getHealthStatistics() async {
  // å¦‚æœ30ç§’å†…å·²è·å–ï¼Œç›´æ¥è¿”å›
  if (_lastStats != null && 
      _lastFetchTime != null && 
      DateTime.now().difference(_lastFetchTime!).inSeconds < 30) {
    return _lastStats!;
  }
  
  // å¦åˆ™é‡æ–°è·å–
  final stats = await _stub.getHealthStatistics(Empty());
  _lastStats = stats;
  _lastFetchTime = DateTime.now();
  return stats;
}
```

---

## ğŸ“ˆ é¢„æœŸæ€§èƒ½æå‡

| ä¼˜åŒ–æ–¹æ¡ˆ | å®æ–½éš¾åº¦ | æ€§èƒ½æå‡ | æ¨èåº¦ |
|---------|---------|----------|-------|
| æ–¹æ¡ˆ1: ç¼“å­˜ | â­ ç®€å• | 10-50å€ | â­â­â­â­â­ |
| æ–¹æ¡ˆ2: å•ä¸€æµ | â­â­â­ ä¸­ç­‰ | 5-10å€ | â­â­â­â­ |
| æ–¹æ¡ˆ3: è°ƒæ•´é—´éš” | â­ æç®€ | 2-3å€ | â­â­â­ |
| æ–¹æ¡ˆ4: ç§»é™¤åµŒå¥— | â­â­ ç®€å• | 2å€ | â­â­â­â­ |
| æ–¹æ¡ˆ5: æ”¹StreamBuilder | â­â­ ç®€å• | 1.5å€ | â­â­â­ |

---

## ğŸ” æ€§èƒ½ç›‘æ§

æ·»åŠ æ—¥å¿—æŸ¥çœ‹å®é™…æ€§èƒ½ï¼š

```dart
Future<pb.HealthStatistics> getHealthStatistics() async {
  final stopwatch = Stopwatch()..start();
  
  final response = await _stub.getHealthStatistics(Empty());
  
  stopwatch.stop();
  print('ğŸ“Š è·å–ç»Ÿè®¡æ•°æ®è€—æ—¶: ${stopwatch.elapsedMilliseconds}ms');
  
  return response;
}
```

---

## âœ… å»ºè®®çš„å®æ–½é¡ºåº

1. **ç«‹å³å®æ–½ï¼š** æ–¹æ¡ˆ3ï¼ˆè°ƒæ•´é—´éš”åˆ°5ç§’ï¼‰
2. **ä»Šå¤©å®æ–½ï¼š** æ–¹æ¡ˆ1ï¼ˆæ·»åŠ ç¼“å­˜ï¼‰+ æ–¹æ¡ˆ4ï¼ˆç§»é™¤åµŒå¥—ï¼‰
3. **æœ¬å‘¨å®æ–½ï¼š** æ–¹æ¡ˆ2ï¼ˆé‡æ„ä¸ºå•ä¸€æ•°æ®æµï¼‰
4. **æœ‰ç©ºå†åšï¼š** æ–¹æ¡ˆ5ï¼ˆæ”¹ç”¨StreamBuilderï¼‰

é¢„è®¡æ€»ä½“æ€§èƒ½æå‡ï¼š**20-100å€** ğŸš€
